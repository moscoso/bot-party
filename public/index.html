<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bot Party ‚Äî Spyfall Stream</title>
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #1a1a20;
      --text: #e4e4e7;
      --muted: #71717a;
      --accent: #a78bfa;
      --green: #22c55e;
      --border: #27272a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "JetBrains Mono", "Fira Code", ui-monospace, monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    h1 { margin: 0; font-size: 1.25rem; font-weight: 600; color: var(--accent); }
    .controls { display: flex; gap: 0.5rem; align-items: center; }
    button {
      font: inherit;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover { filter: brightness(1.1); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .status {
      font-size: 0.875rem;
      color: var(--muted);
    }
    .status.live { color: var(--green); }
    main {
      flex: 1;
      padding: 1rem 1.5rem;
      overflow: auto;
    }
    #log {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem;
      min-height: 320px;
      max-height: 70vh;
      overflow: auto;
      font-size: 0.875rem;
    }
    #log:empty::before {
      content: "Click ‚ÄúStart game‚Äù to run a match. Output will stream here.";
      color: var(--muted);
      padding: 1rem 1.25rem;
      display: block;
    }
    .log-section {
      margin-bottom: 0.25rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    .log-section summary {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-weight: 500;
      color: var(--accent);
      list-style: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
    }
    .log-section summary::-webkit-details-marker { display: none; }
    .log-section summary::before {
      content: "‚ñ∂";
      font-size: 0.7em;
      transition: transform 0.15s ease;
    }
    .log-section[open] summary::before { transform: rotate(90deg); }
    .log-section .section-body {
      padding: 0.75rem 1rem;
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }
    /* Inline debug: collapsible between log lines */
    .inspect-inline {
      margin: 0.35rem 0;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      background: var(--surface);
    }
    .inspect-inline summary {
      padding: 0.35rem 0.6rem;
      cursor: pointer;
      color: var(--muted);
      list-style: none;
      font-size: 0.8rem;
    }
    .inspect-inline summary::-webkit-details-marker { display: none; }
    .inspect-inline summary:hover { color: var(--accent); }
    .inspect-inline .debug-block {
      padding: 0.5rem 0.6rem;
      border-top: 1px solid var(--border);
      background: var(--bg);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 180px;
      overflow: auto;
      font-size: 0.75rem;
      line-height: 1.5;
    }
    .inspect-inline .debug-block + .debug-block { border-top: 1px solid var(--border); }
    .inspect-inline .debug-label { font-size: 0.7rem; color: var(--muted); margin-bottom: 0.15rem; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üïµÔ∏è Bot Party ‚Äî Spyfall</h1>
    <div class="controls">
      <span id="status" class="status">Disconnected</span>
      <label style="font-size:0.8rem;color:var(--muted);">
        Mode:
        <select id="agentMode" style="font:inherit;padding:0.3rem 0.5rem;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:4px;">
          <option value="memory">Memory (Chat Completions)</option>
          <option value="thread">Thread (Assistants API)</option>
        </select>
      </label>
      <button id="start" type="button">Start game</button>
    </div>
  </header>
  <main>
    <div id="log"></div>
  </main>
  <script>
    const logEl = document.getElementById("log");
    const startBtn = document.getElementById("start");
    const statusEl = document.getElementById("status");
    const agentModeEl = document.getElementById("agentMode");

    function sectionTitleFor(line) {
      const roundMatch = line.match(/\[Round (\d+)\]/);
      if (roundMatch) return "Round " + roundMatch[1];
      if (line.includes("VOTING PHASE")) return "Voting";
      if (line.includes("VERDICT")) return "Verdict";
      if (line.includes("attempts a final guess")) return "Spy's guess";
      if (line.includes("ACTUAL LOCATION")) return "Final score";
      return null;
    }

    let currentSection = null;
    let currentBody = null;

    function startSection(title, firstLine) {
      const details = document.createElement("details");
      details.className = "log-section";
      details.open = true;
      const summary = document.createElement("summary");
      summary.textContent = title;
      const body = document.createElement("div");
      body.className = "section-body";
      if (firstLine) body.appendChild(document.createTextNode(firstLine + "\n"));
      details.appendChild(summary);
      details.appendChild(body);
      logEl.appendChild(details);
      currentSection = details;
      currentBody = body;
    }

    function isNearBottom(el) {
      var threshold = 80;
      return el.scrollHeight - el.scrollTop - el.clientHeight < threshold;
    }
    function maybeScrollToBottom() {
      if (isNearBottom(logEl)) logEl.scrollTop = logEl.scrollHeight;
    }

    function appendLine(line) {
      if (!currentBody) startSection("Intro", line);
      else currentBody.appendChild(document.createTextNode(line + "\n"));
      maybeScrollToBottom();
    }

    function appendDebugEntry(entry) {
      if (!currentBody) startSection("Intro", null);
      const phase = entry.phase.charAt(0).toUpperCase() + entry.phase.slice(1);

      if (entry.kind === "sent") {
        // Create new panel with loading indicator
        const details = document.createElement("details");
        details.className = "inspect-inline";
        details.setAttribute("data-prompt-id", entry.id);
        const summary = document.createElement("summary");
        summary.textContent = "üìã " + phase + " (" + entry.agentName + ") ‚Äî prompt & response";
        details.appendChild(summary);

        // Prompt block
        const promptBlock = document.createElement("div");
        promptBlock.className = "debug-block";
        const promptLabel = document.createElement("div");
        promptLabel.className = "debug-label";
        promptLabel.textContent = "Prompt (messages sent)";
        promptBlock.appendChild(promptLabel);
        const promptPre = document.createElement("pre");
        promptPre.textContent = (entry.messages || []).map(function(m) { return "[" + m.role + "]\n" + m.content; }).join("\n\n");
        promptBlock.appendChild(promptPre);
        details.appendChild(promptBlock);

        // Response block with loading indicator
        const responseBlock = document.createElement("div");
        responseBlock.className = "debug-block";
        responseBlock.setAttribute("data-response-block", "true");
        const responseLabel = document.createElement("div");
        responseLabel.className = "debug-label";
        responseLabel.textContent = "Response";
        responseBlock.appendChild(responseLabel);
        const responsePre = document.createElement("pre");
        responsePre.className = "response-content";
        responsePre.innerHTML = '<span style="color:var(--muted);animation:pulse 1.5s ease-in-out infinite;">‚è≥ Waiting for response...</span>';
        responseBlock.appendChild(responsePre);
        details.appendChild(responseBlock);

        currentBody.appendChild(details);
      } else {
        // Find existing panel and update response
        const panel = document.querySelector('[data-prompt-id="' + entry.id + '"]');
        if (panel) {
          const responsePre = panel.querySelector('.response-content');
          if (responsePre) {
            responsePre.textContent = entry.response || "(empty)";
          }
        }
      }
      maybeScrollToBottom();
    }

    function handleLine(line) {
      const title = sectionTitleFor(line);
      if (title) {
        startSection(title, line);
      } else {
        appendLine(line);
      }
    }

    const es = new EventSource("/api/stream");
    es.onopen = () => {
      statusEl.textContent = "Connected";
      statusEl.classList.remove("live");
    };
    es.addEventListener("log", (e) => {
      try {
        const { line } = JSON.parse(e.data);
        if (line) handleLine(line);
      } catch (_) {}
    });
    es.addEventListener("prompt", (e) => {
      try {
        const entry = JSON.parse(e.data);
        appendDebugEntry(entry);
      } catch (_) {}
    });
    es.addEventListener("gameinfo", (e) => {
      try {
        const info = JSON.parse(e.data);
        appendGameInfo(info);
      } catch (_) {}
    });
    es.addEventListener("agentcreated", (e) => {
      try {
        const entry = JSON.parse(e.data);
        appendAgentCreated(entry);
      } catch (_) {}
    });
    es.onerror = () => {
      statusEl.textContent = "Reconnecting‚Ä¶";
      statusEl.classList.remove("live");
    };

    function appendAgentCreated(entry) {
      if (!currentBody) startSection("Intro", null);

      const details = document.createElement("details");
      details.className = "inspect-inline";
      const summary = document.createElement("summary");
      summary.textContent = "ü§ñ Agent Created: " + entry.agentName + " (" + entry.mode + " mode)";
      details.appendChild(summary);

      const block = document.createElement("div");
      block.className = "debug-block";
      const label = document.createElement("div");
      label.className = "debug-label";
      label.textContent = "System Prompt";
      block.appendChild(label);
      const pre = document.createElement("pre");
      pre.textContent = entry.systemPrompt;
      block.appendChild(pre);
      details.appendChild(block);
      currentBody.appendChild(details);
      maybeScrollToBottom();
    }

    function appendGameInfo(info) {
      if (!currentBody) startSection("Intro", null);

      const details = document.createElement("details");
      details.className = "inspect-inline";
      const summary = document.createElement("summary");
      summary.textContent = "üéÆ Game Setup ‚Äî location, roles, spy (spoilers!)";
      details.appendChild(summary);

      const block = document.createElement("div");
      block.className = "debug-block";
      const pre = document.createElement("pre");

      let text = "üìç LOCATION: " + info.location + "\n\n";
      text += "üë• PLAYERS:\n";
      info.players.forEach(function(p) {
        const marker = p.isSpy ? "üïµÔ∏è SPY" : p.role;
        text += "  ‚Ä¢ " + p.name + ": " + marker + "\n";
      });
      text += "\nüìã ROLES AT THIS LOCATION:\n  " + info.roles.join(", ") + "\n";
      text += "\nüó∫Ô∏è ALL POSSIBLE LOCATIONS:\n  " + info.allLocations.join(", ") + "\n";
      text += "\n‚öôÔ∏è CONFIG:\n";
      text += "  ‚Ä¢ Players: " + info.config.numPlayers + "\n";
      text += "  ‚Ä¢ Rounds: " + info.config.rounds + "\n";
      text += "  ‚Ä¢ Agent mode: " + (info.config.agentMode || "memory") + "\n";
      text += "  ‚Ä¢ Human player: " + (info.config.includeHuman ? "yes" : "no");

      pre.textContent = text;
      block.appendChild(pre);
      details.appendChild(block);
      currentBody.appendChild(details);
      maybeScrollToBottom();
    }

    startBtn.addEventListener("click", async () => {
      startBtn.disabled = true;
      statusEl.textContent = "Starting‚Ä¶";
      statusEl.classList.add("live");
      currentSection = null;
      currentBody = null;
      logEl.innerHTML = "";
      try {
        const mode = agentModeEl.value;
        const r = await fetch("/api/start?mode=" + encodeURIComponent(mode), { method: "POST" });
        if (!r.ok) throw new Error(await r.text());
        statusEl.textContent = "Game running (" + mode + ") ‚Äî watch stream below";
      } catch (err) {
        statusEl.textContent = "Error: " + (err instanceof Error ? err.message : String(err));
        logEl.innerHTML = "";
        logEl.appendChild(document.createTextNode("[Request failed: " + (err instanceof Error ? err.message : String(err)) + "]"));
      } finally {
        startBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
